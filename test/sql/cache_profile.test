# name: test/sql/cache_profile.test
# description: test cache profile information
# group: [sql]

require cache_httpfs

# Before enabling profiling, noop profile collector is active (initialized at extension load).
query I
SELECT cache_httpfs_get_profile();
----
No valid access to cache filesystem

statement ok
SELECT COUNT(*) FROM read_csv_auto('https://raw.githubusercontent.com/dentiny/duck-read-cache-fs/refs/heads/main/test/data/stock-exchanges.csv');

# After access, noop profile collector still returns its identifier (no actual stats).
query I
SELECT cache_httpfs_get_profile();
----
(noop profile collector)

# Enable profile, stats should be emitted.
statement ok
SET cache_httpfs_profile_type='temp';

statement ok
SELECT COUNT(*) FROM read_csv_auto('https://raw.githubusercontent.com/dentiny/duck-read-cache-fs/refs/heads/main/test/data/stock-exchanges.csv');

statement ok
SELECT cache_httpfs_get_profile();

#  Create a new cache filesystem, and check profile type doesn't change.
statement ok
SELECT cache_httpfs_wrap_cache_filesystem('cache_httpfs_fake_filesystem');

statement ok
SELECT cache_httpfs_get_profile();
