# name: test/sql/extension_config.test
# description: test extension config fetching
# group: [sql]

require cache_httpfs

# Query cache type.
query IIII
SELECT * FROM cache_httpfs_get_cache_type();
----
on_disk	enabled	enabled	enabled

# Query data cache config.
query IIIII
SELECT * FROM cache_httpfs_get_data_cache_config();
----
on_disk	[/tmp/duckdb_cache_httpfs_cache]	524288	creation_timestamp	page-cache

# Currently implementation late updates cache type on IO access, to check data cache config after update, have to perform an IO operation first.
statement ok
SET cache_httpfs_type='in_mem';

statement ok
SELECT COUNT(*) FROM read_csv_auto('https://raw.githubusercontent.com/dentiny/duck-read-cache-fs/refs/heads/main/test/data/stock-exchanges.csv') LIMIT 1;

query III
SELECT * FROM cache_httpfs_get_data_cache_config();
----
in_mem		524288	lru

# Query metadata cache config.
query II
SELECT * FROM cache_httpfs_get_metadata_cache_config();
----
enabled		250

# Query file handle cache config.
query II
SELECT * FROM cache_httpfs_get_file_handle_cache_config();
----
enabled		250

# Query glob cache config.
query II
SELECT * FROM cache_httpfs_get_glob_cache_config();
----
enabled		64

# Test invalid parameter values - all should fail with validation errors

# Test cache_httpfs_type - invalid value
statement error
SET cache_httpfs_type='invalid_type';
----
Invalid cache_httpfs_type

# Test cache_httpfs_cache_block_size - zero value
statement error
SET cache_httpfs_cache_block_size=0;
----
cache_httpfs_cache_block_size must be greater than 0

# Test cache_httpfs_profile_type - invalid value
statement error
SET cache_httpfs_profile_type='invalid_profile';
----
Invalid cache_httpfs_profile_type

# Test cache_httpfs_cache_directory - empty string falls back to default
statement ok
SET cache_httpfs_cache_directory='';

# Test cache_httpfs_evict_policy - invalid value
statement error
SET cache_httpfs_evict_policy='invalid_policy';
----
Invalid cache_httpfs_evict_policy

# Test cache_httpfs_min_disk_bytes_for_cache - zero value
statement error
SET cache_httpfs_min_disk_bytes_for_cache=0;
----
cache_httpfs_min_disk_bytes_for_cache must be greater than 0

# Test cache_httpfs_disk_cache_reader_mem_cache_block_count - zero value
statement error
SET cache_httpfs_disk_cache_reader_mem_cache_block_count=0;
----
cache_httpfs_disk_cache_reader_mem_cache_block_count must be greater than 0

# Test cache_httpfs_max_in_mem_cache_block_count - zero value
statement error
SET cache_httpfs_max_in_mem_cache_block_count=0;
----
cache_httpfs_max_in_mem_cache_block_count must be greater than 0

# Test cache_httpfs_metadata_cache_entry_size - zero value
statement error
SET cache_httpfs_metadata_cache_entry_size=0;
----
cache_httpfs_metadata_cache_entry_size must be greater than 0

# Test cache_httpfs_file_handle_cache_entry_size - zero value
statement error
SET cache_httpfs_file_handle_cache_entry_size=0;
----
cache_httpfs_file_handle_cache_entry_size must be greater than 0

# Test cache_httpfs_glob_cache_entry_size - zero value
statement error
SET cache_httpfs_glob_cache_entry_size=0;
----
cache_httpfs_glob_cache_entry_size must be greater than 0

# Test cache_httpfs_disk_cache_reader_mem_cache_timeout_millisec - zero value
statement error
SET cache_httpfs_disk_cache_reader_mem_cache_timeout_millisec=0;
----
cache_httpfs_disk_cache_reader_mem_cache_timeout_millisec must be greater than 0

# Test cache_httpfs_in_mem_cache_block_timeout_millisec - zero value
statement error
SET cache_httpfs_in_mem_cache_block_timeout_millisec=0;
----
cache_httpfs_in_mem_cache_block_timeout_millisec must be greater than 0

# Test cache_httpfs_metadata_cache_entry_timeout_millisec - zero value
statement error
SET cache_httpfs_metadata_cache_entry_timeout_millisec=0;
----
cache_httpfs_metadata_cache_entry_timeout_millisec must be greater than 0

# Test cache_httpfs_file_handle_cache_entry_timeout_millisec - zero value
statement error
SET cache_httpfs_file_handle_cache_entry_timeout_millisec=0;
----
cache_httpfs_file_handle_cache_entry_timeout_millisec must be greater than 0

# Test cache_httpfs_glob_cache_entry_timeout_millisec - zero value
statement error
SET cache_httpfs_glob_cache_entry_timeout_millisec=0;
----
cache_httpfs_glob_cache_entry_timeout_millisec must be greater than 0
