# name: test/sql/cache_exclusion.test
# description: test cache exclusion via regex
# group: [sql]

require cache_httpfs

statement ok
SET cache_httpfs_type='on_disk';

query I
SELECT COUNT(*) FROM cache_httpfs_list_exclusion_regex();
----
0

statement ok
SELECT cache_httpfs_add_exclusion_regex('.*duck-read-cache-fs.*');

statement ok
SELECT cache_httpfs_clear_cache();

statement ok
SELECT COUNT(*) FROM read_csv_auto('https://raw.githubusercontent.com/dentiny/duck-read-cache-fs/refs/heads/main/test/data/stock-exchanges.csv');

query I
SELECT cache_httpfs_get_ondisk_data_cache_size();
----
0

# Clear exclusion regex to keep the test hermetic.
statement ok
SELECT cache_httpfs_reset_exclusion_regex();

# Exclusion regex could also be used to only enable certain patterns.
statement ok
SELECT cache_httpfs_add_exclusion_regex('^(?!https://raw\.githubusercontent\.com/dentiny)');

statement ok
SELECT cache_httpfs_clear_cache();

statement ok
SELECT COUNT(*) FROM read_csv_auto('https://raw.githubusercontent.com/dentiny/duck-read-cache-fs/refs/heads/main/test/data/stock-exchanges.csv');

query I
SELECT cache_httpfs_get_ondisk_data_cache_size();
----
16222
