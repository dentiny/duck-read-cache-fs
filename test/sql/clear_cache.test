# name: test/sql/clear_cache.test
# description: test SQL queries with cache cleared
# group: [sql]

require cache_httpfs

statement ok
SELECT cache_httpfs_clear_cache();

query IIIII
SELECT * FROM cache_httpfs_cache_status_query();
----

# Cannot use on-disk cache, because it doesn't support clear cache by filepath.
statement ok
SET cache_httpfs_type='in_mem';

# Start to record profile.
statement ok
SET cache_httpfs_profile_type='temp';

# ==========================
# Uncached query
# ==========================
query I
SELECT COUNT(*) FROM read_csv_auto('https://raw.githubusercontent.com/dentiny/duck-read-cache-fs/refs/heads/main/test/data/stock-exchanges.csv');
----
251

query IIIIII
SELECT * FROM cache_httpfs_cache_access_info_query();
----
metadata	2	1	0	NULL	NULL
data	0	1	0	16222	16222
file handle	0	1	0	NULL	NULL
glob	0	0	0	NULL	NULL

# ==========================
# Clear all cache
# ==========================
# Clear all cache and re-execute the query.
statement ok
SELECT cache_httpfs_clear_cache();

query I
SELECT COUNT(*) FROM read_csv_auto('https://raw.githubusercontent.com/dentiny/duck-read-cache-fs/refs/heads/main/test/data/stock-exchanges.csv');
----
251

query IIIIII
SELECT * FROM cache_httpfs_cache_access_info_query();
----
metadata	4	2	0	NULL	NULL
data	0	2	0	32444	32444
file handle	0	2	0	NULL	NULL
glob	0	0	0	NULL	NULL

# ==========================
# Clear cache by filepath
# ==========================
# Clear cache key-ed by the filepath and re-execute the query.
statement ok
SELECT cache_httpfs_clear_cache_for_file('https://raw.githubusercontent.com/dentiny/duck-read-cache-fs/refs/heads/main/test/data/stock-exchanges.csv');

query I
SELECT COUNT(*) FROM read_csv_auto('https://raw.githubusercontent.com/dentiny/duck-read-cache-fs/refs/heads/main/test/data/stock-exchanges.csv');
----
251

query IIIIII
SELECT * FROM cache_httpfs_cache_access_info_query();
----
metadata	6	3	0	NULL	NULL
data	0	3	0	48666	48666
file handle	0	3	0	NULL	NULL
glob	0	0	0	NULL	NULL
