# name: test/sql/issue_418.test
# description: regression test for issue 418
# group: [sql]

require notwindows

require cache_httpfs

require parquet

statement ok
SET cache_httpfs_type='on_disk';

# Single cache directory with trailing slash: paths must not contain "//"
statement ok
SET cache_httpfs_cache_directory='/tmp/duckdb_cache_issue_418/';

statement ok
SELECT cache_httpfs_clear_cache();

statement ok
SELECT COUNT(*) FROM read_csv_auto('https://raw.githubusercontent.com/dentiny/duck-read-cache-fs/refs/heads/main/test/data/stock-exchanges.csv');

# Multiple cache directories with trailing slashes: paths must not contain "//"
statement ok
SET cache_httpfs_cache_directory='';

statement ok
SET cache_httpfs_cache_directories_config='/tmp/duckdb_cache_418_a/;/tmp/duckdb_cache_418_b/';

statement ok
SELECT cache_httpfs_clear_cache();

statement ok
SELECT COUNT(*) FROM read_csv_auto('https://raw.githubusercontent.com/dentiny/duck-read-cache-fs/refs/heads/main/test/data/stock-exchanges.csv');

statement ok
SELECT COUNT(*) FROM read_parquet('https://blobs.duckdb.org/data/taxi_2019_04.parquet');

# No on-disk cache path may contain double slash when using multiple dirs with trailing slash
query I
SELECT COUNT(*) FROM cache_httpfs_cache_status_query() WHERE cache_type='on-disk' AND cache_filepath LIKE '%//%';
----
0
